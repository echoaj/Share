- name: Copy, compress file
  ansible.windows.win_powershell:
    script: |
      New-SmbMapping -RemotePath '\\10.10.21.84\share' -UserName 'dev\service-account' -Password 'Pas32DE23#$d!'

      # Drop Location Target
      $path_base = "\\10.10.31.12\share\vm-templates\S-Team\Windows\test-win22\3.0.10\20240104-160034"   # Change
      $parsed = $path_base -split '\\'
      $vm_name = $parsed[7]
      $vm_version = $parsed[8]
      $folder_name = "EXPORT-$vm_name-$vm_version-patches"
      $folder_path = "$path_base\$folder_name"

      $wsus_path = "C:\WSUS\WsusContent"
      $date = Get-Date -Format "MMddyyyy"

      New-Item -Path $path_base -Name $folder_name -ItemType "directory"                  # Create folder
      wsusutil export $folder_path\export_$date.xml.gz $folder_path\export_$date.log      # Drop Logs in folder
      Copy-Item -Path $wsus_path -Destination $folder_path -Recurse                       # Copy wsus directory to folder
      Compress-Archive -Path $folder_path -DestinationPath "$folder_path.zip"             # Compress folder to zip
      Remove-Item -Path $folder_path -Force -Recurse                                      # Delete folder
      Get-ChildItem -Path $path_base | Select-Object Name, Length
      Write-Host "Done"
      
  check_mode: no
  register: comp_output
