fortify-check:
  stage: some-stage
  needs:
    - job: previous-job
  script:
    - CRITICAL_OUTPUT=$(FPRUtility -information -project $CI_PROJECT_DIR/target/fortify/*.fpr -search -query "[fortify priority order]:critical")
    - HIGH_OUTPUT=$(FPRUtility -information -project $CI_PROJECT_DIR/target/fortify/*.fpr -search -query "[fortify priority order]:high")
    - MEDIUM_OUTPUT=$(FPRUtility -information -project $CI_PROJECT_DIR/target/fortify/*.fpr -search -query "[fortify priority order]:medium")
    - LOW_OUTPUT=$(FPRUtility -information -project $CI_PROJECT_DIR/target/fortify/*.fpr -search -query "[fortify priority order]:low")

    # Extract the number of vulnerabilities or set to 0 if "No issues matched search query".
    - CRITICAL_COUNT=$( [ "$CRITICAL_OUTPUT" == "No issues matched search query." ] && echo 0 || echo $CRITICAL_OUTPUT | awk '{print $1}' )
    - HIGH_COUNT=$( [ "$HIGH_OUTPUT" == "No issues matched search query." ] && echo 0 || echo $HIGH_OUTPUT | awk '{print $1}' )
    - MEDIUM_COUNT=$( [ "$MEDIUM_OUTPUT" == "No issues matched search query." ] && echo 0 || echo $MEDIUM_OUTPUT | awk '{print $1}' )
    - LOW_COUNT=$( [ "$LOW_OUTPUT" == "No issues matched search query." ] && echo 0 || echo $LOW_OUTPUT | awk '{print $1}' )
    
    - echo "Critical vulnerabilities found: $CRITICAL_COUNT"
    - echo "High vulnerabilities found: $HIGH_COUNT"
    - echo "Medium vulnerabilities found: $MEDIUM_COUNT"
    - echo "Low vulnerabilities found: $LOW_COUNT"
    
    - if [ $CRITICAL_COUNT -gt 0 ] || [ $HIGH_COUNT -gt 0 ] || [ $MEDIUM_COUNT -gt 0 ]; then
        echo "Failing the pipeline due to detected vulnerabilities."
        exit 1
      fi
